<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Heart Physics</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:radial-gradient(circle at 50% 40%, #1b2040 0%, #0d1025 70%);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#stage{
  width:98vmin;
  height:98vmin;
}
canvas{width:100%;height:100%}
</style>
</head>
<body>
<div id="stage"></div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
const {Engine,Render,Runner,Bodies,Composite,Body,Events} = Matter;

const stage=document.getElementById("stage");
const engine=Engine.create();
engine.positionIterations = 10;
engine.velocityIterations = 10;
engine.gravity.y=1;

const w=stage.clientWidth;
const h=stage.clientHeight;

const render=Render.create({
  element:stage,
  engine,
  options:{
    width:w,
    height:h,
    wireframes:false,
    background:"transparent"
  }
});

Render.run(render);
Runner.run(Runner.create(),engine);

// ‚ù§Ô∏è –±—ñ–ª—å—à–∞ —Ñ–æ—Ä–º–∞
function heartPoints(cx,cy,scale,n=200){
  const pts=[];
  for(let i=0;i<n;i++){
    const t=(i/n)*Math.PI*2;
    const x=16*Math.pow(Math.sin(t),3);
    const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    pts.push({x:cx+x*scale,y:cy-y*scale});
  }
  return pts;
}
function generateTextPoints(){

  const off = document.createElement("canvas");
  off.width = w;
  off.height = h;
  const ctx = off.getContext("2d");

  ctx.clearRect(0,0,w,h);

  ctx.fillStyle = "white";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  // –º–æ–∂–Ω–∞ –∑–±—ñ–ª—å—à–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä —è–∫—â–æ —Ç—Ä–µ–±–∞
  ctx.font = "bold 64px Arial";

  ctx.fillText("For My Valentine,", w/2, h/2 - 40);
  ctx.fillText("Marta", w/2, h/2 + 40);

  const data = ctx.getImageData(0,0,w,h).data;

  textPoints = [];

  for(let y=0; y<h; y+=5){
    for(let x=0; x<w; x+=5){

      const i = (y*w + x) * 4;

      // —è–∫—â–æ –ø—ñ–∫—Å–µ–ª—å —Ç–µ–∫—Å—Ç—É
      if(data[i+3] > 150){

        // —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–æ—á–∫–∞ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–µ—Ä—Ü—è
        if(pointInsideHeart(x,y)){
          textPoints.push({x,y});
        }
      }
    }
  }

  // –ø–µ—Ä–µ–º—ñ—à—É–≤–∞–Ω–Ω—è (Fisher‚ÄìYates)
  for (let i = textPoints.length - 1; i > 0; i--) {
    const j = (Math.random() * (i + 1)) | 0;
    [textPoints[i], textPoints[j]] = [textPoints[j], textPoints[i]];
  }

  // —Å—Ç–≤–æ—Ä—é—î–º–æ targets –ø—ñ–¥ –∫–æ–∂–Ω–µ —Å–µ—Ä–¥–µ—á–∫–æ
  targets = [];
  for(let i=0;i<hearts.length;i++){
    targets[i] = textPoints[i % textPoints.length];
  }
}

const centerX=w/2;
const centerY=h/2;
const scale=Math.min(w,h)*0.028; // üî• –±—ñ–ª—å—à–µ
const pts=heartPoints(centerX,centerY,scale);

// –∫–æ–Ω—Ç—É—Ä
Events.on(render,"afterRender",()=>{
  const ctx=render.context;

  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);
  for(let p of pts) ctx.lineTo(p.x,p.y);
  ctx.closePath();

  const grad=ctx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0,"#ff6aa2");
  grad.addColorStop(1,"#ff003c");

  ctx.strokeStyle=grad;
  ctx.lineWidth=6;
  ctx.shadowBlur=25;
  ctx.shadowColor="#ff3d7a";
  ctx.stroke();
  ctx.shadowBlur=0;

  ctx.textAlign="center";
  ctx.textBaseline="middle";
  for(const hrt of hearts){
    const p=hrt.body.position;
    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.rotate(hrt.body.angle);
    ctx.font=hrt.r*2+"px system-ui, Apple Color Emoji";
    ctx.fillText("‚ù§Ô∏è",0,0);
    ctx.restore();
  }
});

// —Ñ—ñ–∑–∏—á–Ω—ñ —Å—Ç—ñ–Ω–∫–∏
for(let i=0;i<pts.length;i++){
  const a=pts[i];
  const b=pts[(i+1)%pts.length];
  const dx=b.x-a.x;
  const dy=b.y-a.y;
  const len=Math.hypot(dx,dy);
  const angle=Math.atan2(dy,dx);

  const wall=Bodies.rectangle(
    (a.x+b.x)/2,
    (a.y+b.y)/2,
    len+20,
    20,
    {isStatic:true}
  );
  Body.setAngle(wall,angle);
  Composite.add(engine.world,wall);
}

// ‚ù§Ô∏è –º–∞–ª–µ–Ω—å–∫—ñ —Å–µ—Ä–¥–µ—á–∫–∞
const hearts=[];
let textMode = false;
let textPoints = [];
let targets = [];

function pointInsideHeart(x,y){
  const dx=(x-centerX)/scale;
  const dy=(centerY-y)/scale;
  return Math.pow(dx*dx+dy*dy-1,3)-dx*dx*dy*dy*dy <= 0;
}

function randomInside(){
  let x,y;
  do{
    x=centerX+(Math.random()-0.5)*scale*18;
    y=centerY+(Math.random()-0.5)*scale*18;
  }while(!pointInsideHeart(x,y));
  return {x,y};
}

function spawn(){
  const r = 6 + Math.random()*3;
  const pos = randomInside();

  const body = Bodies.circle(pos.x,pos.y,r,{
    restitution:0.05,
    friction:0.15,
    frictionAir:0.001,
    density:0.003,
    render:{visible:false}
  });

  Composite.add(engine.world,body);
  hearts.push({body,r});

  // üî• –ê–ö–¢–ò–í–ê–¶–Ü–Ø –¢–ï–ö–°–¢–£
  if(hearts.length > 350 && !textMode){
    textMode = true;
    generateTextPoints();
  }

  // –ª—ñ–º—ñ—Ç —á–∞—Å—Ç–∏–Ω–æ–∫
  if(hearts.length > 600){
    Composite.remove(engine.world,hearts.shift().body);
  }
}

// üì± shake
let lastShake=0;
function motion(e){
  const now = Date.now();

  // —è–∫—â–æ –∑–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç: –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –≤—Å—ñ ‚Äú—Ö–∞–æ—Ç–∏—á–Ω—ñ‚Äù —Å–∏–ª–∏
  if(textMode){
    engine.gravity.x = 0;
    engine.gravity.y = 0;

    if(textPoints.length && targets.length){
      for(let i=0;i<hearts.length;i++){
        const h = hearts[i];
        const t = targets[i] || textPoints[i % textPoints.length];

        const dx = t.x - h.body.position.x;
        const dy = t.y - h.body.position.y;

        // —Å–∏–ª—å–Ω—ñ—à–∏–π –º–∞–≥–Ω—ñ—Ç + –æ–±–º–µ–∂–µ–Ω–Ω—è, —â–æ–± –Ω–µ ‚Äú–≤–∏–±—É—Ö–∞–ª–æ‚Äù
        const fx = Math.max(-0.003, Math.min(0.003, dx * 0.00012));
        const fy = Math.max(-0.003, Math.min(0.003, dy * 0.00012));

        Body.applyForce(h.body, h.body.position, { x: fx, y: fy });

        // –≥–∞—Å–∏–º–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å, —â–æ–± –≤–æ–Ω–æ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞–≤–∞–ª–æ –Ω–∞ –º—ñ—Å—Ü–µ
        Body.setVelocity(h.body, {
          x: h.body.velocity.x * 0.85,
          y: h.body.velocity.y * 0.85
        });

        // –∫–æ–ª–∏ –¥—É–∂–µ –±–ª–∏–∑—å–∫–æ, –º–∞–π–∂–µ ‚Äú–ø—Ä–∏–∫–ª–µ—é—î–º–æ‚Äù
        if (dx*dx + dy*dy < 25) {
          Body.setVelocity(h.body, { x: 0, y: 0 });
        }
      }
    }
    return;
  }

  // ---------- NORMAL MODE (–¥–æ —Ç–µ–∫—Å—Ç—É) ----------

  // 1) –®–ï–ô–ö (fallback –Ω–∞ includingGravity —è–∫—â–æ acceleration null)
  const a = e.acceleration || e.accelerationIncludingGravity;
  if(a){
    const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);

    if(mag > 12 && now-lastShake > 200){
      lastShake = now;
      for(let i=0;i<20;i++) spawn();
    }

    if(mag > 22){
      for(const h of hearts){
        Body.applyForce(h.body, h.body.position, {
          x:(Math.random()-0.5)*0.002,
          y:-0.004 - Math.random()*0.002
        });
      }
    }
  }

  // 2) –ù–ê–•–ò–õ
  const g = e.accelerationIncludingGravity;
  if(g){
    engine.gravity.x = -(g.x || 0) / 10;
    engine.gravity.y =  (g.y || 0) / 10;

    // —ñ–º–ø—É–ª—å—Å –ø—Ä–∏ —Ä—ñ–∑–∫–æ–º—É –ø–æ–≤–æ—Ä–æ—Ç—ñ
    const tiltMag = Math.sqrt((g.x||0)**2 + (g.y||0)**2);
    if(tiltMag > 15){
      for(const h of hearts){
        Body.applyForce(h.body, h.body.position, {
          x:(Math.random()-0.5)*0.0008,
          y:(Math.random()-0.5)*0.0008
        });
      }
    }

    // —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω—ñ—Å—Ç—å
    for(const h of hearts){
      Body.applyForce(h.body, h.body.position, {
        x:(Math.random()-0.5)*0.00015,
        y:(Math.random()-0.5)*0.00015
      });
    }
  }
}

    // üå™ –ª–µ–≥–∫–∞ –ø–æ—Å—Ç—ñ–π–Ω–∞ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω—ñ—Å—Ç—å
if(!textMode){
  for(const h of hearts){
    Body.applyForce(
      h.body,
      h.body.position,
      {
        x:(Math.random()-0.5)*0.00015,
        y:(Math.random()-0.5)*0.00015
      }
    );
  }
}
  }

  // üíñ 3. –ú–ê–ì–ù–Ü–¢ –î–û –¢–ï–ö–°–¢–£
  if(textMode && textPoints.length){

    for(let i=0;i<hearts.length;i++){
      const target = textPoints[i % textPoints.length];
      const h = hearts[i];

const dx = target.x - h.body.position.x;
const dy = target.y - h.body.position.y;

Body.applyForce(
  h.body,
  h.body.position,
  {
    x: dx * 0.00008,
    y: dy * 0.00008
  }
);

// —Ç—Ä–æ—Ö–∏ –≥–∞—Å–∏–º–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å, —â–æ–± —Å—Ç–∞–±—ñ–ª—ñ–∑—É–≤–∞—Ç–∏
Body.setVelocity(h.body, {
  x: h.body.velocity.x * 0.9,
  y: h.body.velocity.y * 0.9
});
    }
  }
}

window.addEventListener("pointerdown",()=>{
  window.addEventListener("devicemotion",motion,{passive:true});
},{once:true});

// –ü–ö —Ç–µ—Å—Ç
window.addEventListener("keydown",e=>{
  if(e.code==="Space"){
    for(let i=0;i<20;i++)spawn();
  }
});
</script>
</body>
</html>







